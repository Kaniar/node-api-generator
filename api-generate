#!/bin/bash

install=true;if [ "$1" == "-route" ];then if [ -z "$2" ];then echo "Error: Adding route need name">&2;echo "Usage: api-generate -route \"name\" \"endpoint (/something)\"">&2;exit 1;fi;if [ -z "$3" ];then echo "Error: Adding route need event">&2;echo "Usage: api-generate -route \"name\" \"endpoint (/something)\"">&2;exit 1;fi;install=false;name=$(echo "$2"|tr '[:upper:]' '[:lower:]');filesed=".\/lib\/$name";file="./lib/$name.js";endpoint="$3";sed -i "1s/^/var $name = require('$filesed')();\n/" app.js;echo -e "app.use(\"$endpoint\", $name);">>app.js;echo -e "module.exports = function() {\n\tvar express = require('express');\n\tvar bodyParser = require('body-parser');\n\tvar urlencodedParser = bodyParser.urlencoded({ extended: true });\n\tvar router = express.Router();\n\n">$file;echo -e "\trouter.use(function(req, res, next) {\n\t\tnext();\n\t});\n\n\t">>$file;echo -e "\trouter.route('/').get(function(req, res) {\n\tres.send(\"$name\");\n\t});">>$file;echo -e "\n\treturn router;\n\t};">>$file;fi;if [ "$install" = true ];then if [ "$(id -u)" != "0" ];then echo "This script must be run as root" 1>&2;exit 1;fi;if ! [ -x "$(command -v node)" ];then echo 'Error: NodeJS is not installed.'>&2;exit 1;fi;rm -rf database lib;mkdir database lib;if ! [ $? -eq 0 ];then echo "Error: cannot create directory.">&2;exit 1;fi;echo -e "{\n\t\"name\":\""api"\",\n\t\"version\":\""0.1.0"\",\n\t\"main\":\""app.js"\",\n\t\"dependencies\": {\n\t\t\"body-parser\":\"^1.10.2\",\n\t\t\"cookie-session\":\"^1.1.0\",\n\t\t\"express\":\"~4.11.0\",\n\t\t\"formidable\":\"^1.2.1\"\n\t}\n}">package.json;sudo npm install;if ! [ $? -eq 0 ];then echo "error: installation of dependencies failed.">&2;exit 1;fi;echo -e "var express = require('express');\nvar app = express();\nvar http = require('http').Server(app);\nvar router = express.Router();\nvar routes = require('./lib/routes')();\n\nrouter.use(function(req, res, next){\n\tnext();\n});\n\nvar server = app.listen(8000);\napp.use(\"/\", routes);">app.js;if ! [ $? -eq 0 ];then echo "error: impossible to create app.js.">&2;exit 1;fi;echo "app.js created";file="./lib/routes.js";echo -e "module.exports = function() {\n\tvar express = require('express');\n\tvar bodyParser = require('body-parser');\n\tvar urlencodedParser = bodyParser.urlencoded({ extended: true });\n\tvar router = express.Router();\n\n">$file;echo -e "\trouter.use(function(req, res, next) {\n\t\tnext();\n\t});\n\n\t">>$file;echo -e "\trouter.route('/').get(function(req, res) {\n\tres.send(\"Hello world !\");\n\t});">>$file;echo -e "\n\treturn router;\n\t};">>$file;fi
